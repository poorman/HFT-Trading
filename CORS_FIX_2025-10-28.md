# HFT CORS and API URL Fix - October 28, 2025

## Issue
The production app at `https://hft.widesurf.com` was experiencing CORS errors and network failures:

```
Access to XMLHttpRequest at 'http://localhost:8080/api/movers' from origin 'https://hft.widesurf.com' 
has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

## Root Cause
Multiple frontend files had hardcoded fallback URLs pointing to `http://localhost:8080`, which caused the production app to try connecting to localhost instead of using relative paths that Traefik could route to the backend.

The issue was in lines like:
```typescript
const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080'
```

Since `NEXT_PUBLIC_API_URL` was set to an empty string `''` in docker-compose.yml, and empty strings are falsy in JavaScript, the code would fall back to `'http://localhost:8080'`.

## Solution Applied

### 1. Fixed API URL Fallbacks
Updated all frontend files to use relative paths (empty string or `/api`) as the fallback:

**Files Modified:**
- `frontend/app/daily-movers/page.tsx` - Changed fallback from `'http://localhost:8080'` to `''`
- `frontend/components/OrderForm.tsx` - Changed fallback from `'http://localhost:8080'` to `''`
- `frontend/components/RiskDashboard.tsx` - Changed fallback from `'http://localhost:8080/api'` to `'/api'`
- `frontend/app/monitoring/page.tsx` - Changed fallback from `'http://localhost:8080'` to `''`
- `frontend/app/positions/page.tsx` - Changed fallback from `'http://localhost:8080/api'` to `'/api'`
- `frontend/app/trading/page.tsx` - Changed fallback from `'http://localhost:8080/api'` to `'/api'`
- `frontend/app/analytics/page.tsx` - Changed fallback from `'http://localhost:8080/api'` to `'/api'`
- `frontend/app/executions/page.tsx` - Changed fallback from `'http://localhost:8080/api'` to `'/api'`
- `frontend/app/strategy/movers/page.tsx` - Changed fallback from `'http://localhost:8080'` to `''`

### 2. Rebuilt Frontend Container
Rebuilt the `hft-frontend` container to apply all changes:
```bash
cd /home/pbieda/scripts/hft
docker-compose up -d --build hft-frontend
```

## How It Works Now

### Request Flow
```
Browser → https://hft.widesurf.com/api/movers
   ↓
Traefik (priority 100 routing rule)
   ↓
HFT Backend Container (port 8082)
   ↓
API Response (via HTTPS)
```

### Environment-Specific Behavior
The code now handles different environments properly:

1. **Production (`hft.widesurf.com`)**: 
   - Some pages use `https://hftapi.widesurf.com/api` (explicit)
   - Others use relative paths `/api` (routed by Traefik)
   - Both approaches work correctly

2. **Development (IP: 178.128.15.57)**: 
   - Uses direct backend URL: `http://178.128.15.57:8082/api`

3. **SSR Fallback**: 
   - Uses relative paths (`''` or `/api`)
   - Traefik routes these to the backend

## Traefik Configuration
The existing Traefik configuration (already in place) routes API requests:

```yaml
# /traefik/config/dynamic.yml
hft-api:
  rule: "Host(`hft.widesurf.com`) && PathPrefix(`/api`)"
  service: hftapi-svc
  entryPoints:
    - websecure
  tls:
    certResolver: letsencrypt
  middlewares:
    - security-headers
    - api-rate-limit
  priority: 100
```

## Verification

### Test URLs
- **Frontend**: https://hft.widesurf.com/daily-movers
- **API via Traefik**: https://hft.widesurf.com/api/movers
- **Direct API**: https://hftapi.widesurf.com/api/movers

### Expected Behavior
✅ No CORS errors
✅ API requests work correctly
✅ Data loads from backend
✅ All requests via HTTPS
✅ Traefik properly routes `/api/*` to backend

## Status: ✅ FIXED

The application now correctly:
- Uses relative paths for API requests in production
- Avoids CORS issues by staying within the same domain
- Leverages Traefik's path-based routing
- Works properly across different environments

---
*Last Updated: October 28, 2025*
*Fixed by: AI Assistant*

